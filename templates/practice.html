{% extends "base.html" %}

{% block title %}{{ topic.name }} ë¬¸ì œ í’€ì´ - ì¤‘í•™êµ ìˆ˜í•™{% endblock %}

{% block content %}
<div class="container">
    <div class="breadcrumb">
        <a href="/">í™ˆ</a> / <a href="/topic/{{ topic_key }}">{{ topic.name }}</a> / <span>ë¬¸ì œ í’€ì´</span>
    </div>

    <div class="practice-header">
        <h1>{{ topic.name }} ë¬¸ì œ í’€ì´</h1>
        <p>ë¬¸ì œë¥¼ í’€ê³  ì •ë‹µì„ í™•ì¸í•´ë³´ì„¸ìš”!</p>
    </div>

    <div class="practice-container">
        <div class="problem-section">
            <div class="problem-card">
                <h3>ë¬¸ì œ</h3>
                <div id="problem-text" class="problem-text">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                <div id="hint-section" class="hint-section" style="display: none;">
                    <strong>íŒíŠ¸:</strong> <span id="hint-text"></span>
                </div>
            </div>

            <div class="answer-section">
                <label for="user-answer">ë‹µì•ˆ ì…ë ¥:</label>
                <input type="text" id="user-answer" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" class="answer-input">
                <div class="answer-buttons">
                    <button onclick="checkAnswer()" class="btn btn-primary">ì •ë‹µ í™•ì¸</button>
                    <button onclick="showHint()" class="btn btn-secondary">íŒíŠ¸ ë³´ê¸°</button>
                    <button onclick="loadNewProblem()" class="btn btn-success">ìƒˆ ë¬¸ì œ</button>
                </div>
            </div>

            <div id="result-section" class="result-section" style="display: none;">
                <div id="result-message" class="result-message"></div>
            </div>
        </div>

        <div class="stats-section">
            <div class="stats-card">
                <h3>í†µê³„</h3>
                <div class="stat-item">
                    <span>í’€ì´í•œ ë¬¸ì œ:</span>
                    <span id="total-problems">0</span>
                </div>
                <div class="stat-item">
                    <span>ì •ë‹µ:</span>
                    <span id="correct-answers">0</span>
                </div>
                <div class="stat-item">
                    <span>ì •ë‹µë¥ :</span>
                    <span id="accuracy">0%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <a href="/topic/{{ topic_key }}" class="btn btn-secondary">í•™ìŠµ ë‚´ìš© ë³´ê¸°</a>
        <a href="/" class="btn btn-secondary">í™ˆìœ¼ë¡œ</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentProblem = null;
    let stats = {
        total: 0,
        correct: 0
    };

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°
    window.addEventListener('DOMContentLoaded', function() {
        loadNewProblem();
        loadStats();
    });

    function loadNewProblem() {
        fetch(`/api/generate_problem/{{ topic_key }}`)
            .then(response => response.json())
            .then(data => {
                currentProblem = data;
                document.getElementById('problem-text').textContent = data.problem;
                document.getElementById('hint-text').textContent = data.hint;
                document.getElementById('hint-section').style.display = 'none';
                document.getElementById('result-section').style.display = 'none';
                document.getElementById('user-answer').value = '';
                document.getElementById('user-answer').focus();
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('problem-text').textContent = 'ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            });
    }

    function checkAnswer() {
        const userAnswer = document.getElementById('user-answer').value.trim();
        if (!userAnswer) {
            alert('ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        stats.total++;
        let isCorrect = false;
        const answer = currentProblem.answer;

        if (Array.isArray(answer)) {
            // ë°°ì—´ì¸ ê²½ìš° (ì´ì°¨ë°©ì •ì‹ ë“±)
            isCorrect = answer.some(a => Math.abs(parseFloat(userAnswer) - parseFloat(a)) < 0.01);
        } else if (typeof answer === 'string') {
            // ë¬¸ìì—´ì¸ ê²½ìš° (ì¸ìˆ˜ë¶„í•´ ë“±)
            isCorrect = userAnswer.replace(/\s/g, '') === answer.replace(/\s/g, '');
        } else {
            // ìˆ«ìì¸ ê²½ìš°
            isCorrect = Math.abs(parseFloat(userAnswer) - parseFloat(answer)) < 0.01;
        }

        if (isCorrect) {
            stats.correct++;
            showResult('ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰', 'correct');
        } else {
            const answerText = Array.isArray(answer) ? answer.join(' ë˜ëŠ” ') : answer;
            showResult(`í‹€ë ¸ìŠµë‹ˆë‹¤. ì •ë‹µì€ ${answerText}ì…ë‹ˆë‹¤.`, 'incorrect');
        }

        updateStats();
    }

    function showHint() {
        document.getElementById('hint-section').style.display = 'block';
    }

    function showResult(message, type) {
        const resultSection = document.getElementById('result-section');
        const resultMessage = document.getElementById('result-message');
        resultMessage.textContent = message;
        resultMessage.className = 'result-message ' + type;
        resultSection.style.display = 'block';
    }

    function updateStats() {
        document.getElementById('total-problems').textContent = stats.total;
        document.getElementById('correct-answers').textContent = stats.correct;
        const accuracy = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
        document.getElementById('accuracy').textContent = accuracy + '%';
        saveStats();
    }

    function loadStats() {
        const savedStats = localStorage.getItem('mathStats_{{ topic_key }}');
        if (savedStats) {
            stats = JSON.parse(savedStats);
            updateStats();
        }
    }

    function saveStats() {
        localStorage.setItem('mathStats_{{ topic_key }}', JSON.stringify(stats));
    }

    // Enter í‚¤ë¡œ ì •ë‹µ í™•ì¸
    document.getElementById('user-answer').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkAnswer();
        }
    });
</script>
{% endblock %}
